#!/bin/sh

#--------------------------#
# USING IPHONE CAM AND MIC #
#--------------------------#

echo "Enabling usbmuxd service"
sudo -A systemctl stop usbmuxd.service
sudo -A systemctl start usbmuxd.service
LOG=$(mktemp)
echo "Starting droidcam on port 4747"
stdbuf -i0 -o0 -e0 droidcam-cli -a -v ios 4747 $@ >$LOG 2>&1 &
pid=$!
echo "Sleeping for 5 seconds..."
sleep 5
ps -p $pid > /dev/null
if [ $? -eq 0 ]; then
        audio_device=$(grep -oE "hw:[0-9],[0-9],[0-9]" $LOG)
        echo "Loading audio module for input"
        pacmd load-module module-alsa-source device=$audio_device
        wait
        pacmd unload-module module-alsa-source
        rm $LOG
fi
